{"version":3,"sources":["../../../../../src/features/commenting/components/input/CommentInputBox.tsx"],"sourcesContent":["'use client'\n\nimport type { RangeSelection } from '@payloadcms/richtext-lexical/lexical'\n\nimport { $getSelection, $isRangeSelection } from '@payloadcms/richtext-lexical/lexical'\nimport { createDOMRange, createRectsFromDOMRange } from '@payloadcms/richtext-lexical/lexical/selection'\nimport React, { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react'\nimport { createPortal } from 'react-dom'\n\nimport type { CommentInputBoxProps } from '../../types/props.js'\n\nimport { createComment, createThread } from '../../utils/factory.js'\n\nexport const CommentInputBox: React.FC<CommentInputBoxProps> = ({\n  author,\n  cancelAddComment,\n  editor,\n  setActiveAnchorKey,\n  setShowCommentInput,\n  submitAddComment,\n}) => {\n  const [content, setContent] = useState('')\n  const [canSubmit, setCanSubmit] = useState(false)\n  const boxRef = useRef<HTMLDivElement>(null)\n  const textareaRef = useRef<HTMLTextAreaElement>(null)\n  const selectionState = useMemo(\n    () => ({\n      container: document.createElement('div'),\n      elements: [],\n    }),\n    [],\n  )\n  const selectionRef = useRef<null | RangeSelection>(null)\n\n  const updateLocation = useCallback(() => {\n    editor.getEditorState().read(() => {\n      const selection = $getSelection()\n\n      if ($isRangeSelection(selection)) {\n        selectionRef.current = selection.clone()\n        const anchor = selection.anchor\n        const focus = selection.focus\n        const range = createDOMRange(\n          editor,\n          anchor.getNode(),\n          anchor.offset,\n          focus.getNode(),\n          focus.offset,\n        )\n        const boxElem = boxRef.current\n        const editorRoot = editor.getRootElement()\n        \n        if (range !== null && boxElem !== null && editorRoot !== null) {\n          const editorRect = editorRoot.getBoundingClientRect()\n          const rangeRect = range.getBoundingClientRect()\n          const selectionRects = createRectsFromDOMRange(editor, range)\n          \n          // Calculate left position relative to viewport\n          let correctedLeft =\n            selectionRects.length === 1 \n              ? rangeRect.left + rangeRect.width / 2 - 125 \n              : rangeRect.left - 125\n          \n          // Ensure the box stays within the editor bounds\n          correctedLeft = Math.max(10, Math.min(correctedLeft, editorRect.width - 260))\n          \n          // Calculate top position relative to viewport\n          const viewportHeight = window.innerHeight\n          let topPosition = rangeRect.bottom + window.scrollY + 20\n          \n          // If the box would overflow the viewport bottom, position it above the selection\n          const absoluteTop = rangeRect.bottom + 20 // Viewport-relative top position\n          if (boxElem.offsetHeight && absoluteTop + boxElem.offsetHeight > viewportHeight) {\n            topPosition = rangeRect.top + window.scrollY - (boxElem.offsetHeight + 10)\n          }\n          \n          // Apply the calculated positions\n          boxElem.style.position = 'absolute'\n          boxElem.style.left = `${correctedLeft}px`\n          boxElem.style.top = `${topPosition}px`\n          \n          // Update highlight overlays\n          const selectionRectsLength = selectionRects.length\n          const { container } = selectionState\n          const elements: Array<HTMLSpanElement> = selectionState.elements\n          const elementsLength = elements.length\n\n          for (let i = 0; i < selectionRectsLength; i++) {\n            const selectionRect = selectionRects[i]\n            let elem: HTMLSpanElement = elements[i]\n            if (elem === undefined) {\n              elem = document.createElement('span')\n              elements[i] = elem\n              container.appendChild(elem)\n            }\n            const color = '255, 212, 0'\n            const style = `position:absolute;top:${\n              selectionRect.top + window.scrollY\n            }px;left:${selectionRect.left}px;height:${\n              selectionRect.height\n            }px;width:${\n              selectionRect.width\n            }px;background-color:rgba(${color}, 0.3);pointer-events:none;z-index:5;`\n            elem.style.cssText = style\n          }\n          \n          // Clean up any extra highlight elements\n          for (let i = elementsLength - 1; i >= selectionRectsLength; i--) {\n            const elem = elements[i]\n            container.removeChild(elem)\n            elements.pop()\n          }\n        }\n      }\n    })\n  }, [editor, selectionState])\n\n  useLayoutEffect(() => {\n    updateLocation()\n    const container = selectionState.container\n    const body = document.body\n    if (body !== null) {\n      body.appendChild(container)\n      return () => {\n        body.removeChild(container)\n      }\n    }\n  }, [selectionState.container, updateLocation])\n\n  useEffect(() => {\n    window.addEventListener('resize', updateLocation)\n    window.addEventListener('scroll', updateLocation, true)\n\n    return () => {\n      window.removeEventListener('resize', updateLocation)\n      window.removeEventListener('scroll', updateLocation, true)\n    }\n  }, [updateLocation])\n\n  // Focus the textarea after a small delay to prevent scroll jump\n  useEffect(() => {\n    const timeoutId = setTimeout(() => {\n      if (textareaRef.current) {\n        textareaRef.current.focus()\n      }\n    }, 0)\n    return () => clearTimeout(timeoutId)\n  }, [])\n\n  const submitComment = () => {\n    if (canSubmit) {\n      let quote = editor.getEditorState().read(() => {\n        const selection = selectionRef.current\n        return selection ? selection.getTextContent() : ''\n      })\n      if (quote.length > 100) {\n        quote = quote.slice(0, 99) + 'â€¦'\n      }\n      submitAddComment(\n        createThread(quote, [createComment(content, author)]),\n        true,\n        undefined,\n        selectionRef.current,\n      )\n      selectionRef.current = null\n      // Reset the active anchor key to hide the AddCommentBox tooltip\n      setActiveAnchorKey(null)\n      // Close the comment input form\n      setShowCommentInput(false)\n    }\n  }\n\n  const handleInputChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n    const newContent = e.target.value\n    setContent(newContent)\n    setCanSubmit(newContent.trim().length > 0)\n  }\n\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    if (e.key === 'Escape') {\n      e.preventDefault()\n      cancelAddComment()\n    } else if (e.key === 'Enter' && (e.ctrlKey || e.metaKey) && canSubmit) {\n      e.preventDefault()\n      submitComment()\n    }\n  }\n\n  return createPortal(\n    <div className=\"CommentPlugin_CommentInputBox\" ref={boxRef}>\n      <div className=\"CommentPlugin_CommentInputBox_EditorContainer\">\n        <textarea\n          aria-label=\"Comment text\"\n          className=\"CommentPlugin_CommentInputBox_Editor\"\n          onChange={handleInputChange}\n          onKeyDown={handleKeyDown}\n          placeholder=\"Type a comment...\"\n          ref={textareaRef}\n          value={content}\n        />\n      </div>\n      <div className=\"CommentPlugin_CommentInputBox_Buttons\">\n        <button\n          className=\"CommentPlugin_CommentInputBox_Button\"\n          onClick={cancelAddComment}\n          type=\"button\"\n        >\n          Cancel\n        </button>\n        <button\n          className=\"CommentPlugin_CommentInputBox_Button primary\"\n          disabled={!canSubmit}\n          onClick={submitComment}\n          type=\"button\"\n        >\n          Comment\n        </button>\n      </div>\n    </div>,\n    document.body,\n  )\n}\n"],"names":["$getSelection","$isRangeSelection","createDOMRange","createRectsFromDOMRange","React","useCallback","useEffect","useLayoutEffect","useMemo","useRef","useState","createPortal","createComment","createThread","CommentInputBox","author","cancelAddComment","editor","setActiveAnchorKey","setShowCommentInput","submitAddComment","content","setContent","canSubmit","setCanSubmit","boxRef","textareaRef","selectionState","container","document","createElement","elements","selectionRef","updateLocation","getEditorState","read","selection","current","clone","anchor","focus","range","getNode","offset","boxElem","editorRoot","getRootElement","editorRect","getBoundingClientRect","rangeRect","selectionRects","correctedLeft","length","left","width","Math","max","min","viewportHeight","window","innerHeight","topPosition","bottom","scrollY","absoluteTop","offsetHeight","top","style","position","selectionRectsLength","elementsLength","i","selectionRect","elem","undefined","appendChild","color","height","cssText","removeChild","pop","body","addEventListener","removeEventListener","timeoutId","setTimeout","clearTimeout","submitComment","quote","getTextContent","slice","handleInputChange","e","newContent","target","value","trim","handleKeyDown","key","preventDefault","ctrlKey","metaKey","div","className","ref","textarea","aria-label","onChange","onKeyDown","placeholder","button","onClick","type","disabled"],"mappings":"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"}