{"version":3,"sources":["../../../../../src/features/commenting/components/core/CommentPlugin.tsx"],"sourcesContent":["'use client'\n\nimport type { NodeKey } from '@payloadcms/richtext-lexical/lexical'\n\nimport { useLexicalComposerContext } from '@payloadcms/richtext-lexical/lexical/react/LexicalComposerContext'\nimport React, { useEffect, useMemo, useState } from 'react'\nimport { createPortal } from 'react-dom'\n\nimport type { Thread } from '../../types/core.js'\nimport type { CommentPluginProps } from '../../types/props.js'\n\nimport { useCommentCommands } from '../../hooks/editor/useCommentCommands.js'\nimport { useCommentMarks } from '../../hooks/editor/useCommentMarks.js'\nimport { useCommentOperations } from '../../hooks/useCommentOperations.js'\nimport { useDocumentOperations } from '../../hooks/useDocumentOperations.js'\nimport { CommentStore, useCommentStore } from '../../store.js'\nimport { AddCommentBox } from '../input/AddCommentBox.js'\nimport { CommentInputBox } from '../input/CommentInputBox.js'\nimport { CommentsPanel } from './CommentPanel.js'\nimport '../ui/CommentPlugin.css'\n\n/**\n * CommentPlugin component for the Lexical editor\n * \n * This component provides commenting functionality for the Lexical editor,\n * including adding, viewing, and deleting comments.\n */\nexport const CommentPlugin: React.FC<CommentPluginProps> = ({\n  currentUser,\n  documentId = 'default',\n  userCollectionSlug,\n}) => {\n  // Editor context\n  const [editor] = useLexicalComposerContext()\n\n  // Comment store\n  const commentStore = useMemo(() => new CommentStore(editor, userCollectionSlug), [editor, userCollectionSlug])\n  const comments = useCommentStore(commentStore)\n  \n  // UI state\n  const [activeAnchorKey, setActiveAnchorKey] = useState<NodeKey | null>(null)\n  const [activeIDs, setActiveIDs] = useState<Array<string>>([])\n  const [showCommentInput, setShowCommentInput] = useState(false)\n  const [showComments, setShowComments] = useState(false)\n  \n  // Custom hooks\n  const markNodeMap = useCommentMarks(editor, setActiveIDs, setActiveAnchorKey)\n  const { isDocumentSaved, saveDocument } = useDocumentOperations(editor, documentId)\n  const { deleteAllComments, deleteCommentOrThread, resolveThread, submitAddComment } = useCommentOperations(\n    commentStore, \n    editor, \n    markNodeMap, \n    saveDocument\n  )\n  const { cancelAddComment, onAddComment, toggleComments } = useCommentCommands(\n    editor,\n    setShowCommentInput,\n    setShowComments,\n    showComments,\n    showCommentInput,\n    setActiveAnchorKey\n  )\n\n  // Highlight active comments\n  useEffect(() => {\n    const changedElems: Array<HTMLElement> = []\n    for (let i = 0; i < activeIDs.length; i++) {\n      const id = activeIDs[i]\n      const keys = markNodeMap.get(id)\n      if (keys !== undefined) {\n        for (const key of keys) {\n          const elem = editor.getElementByKey(key)\n          if (elem !== null) {\n            elem.classList.add('selected')\n            changedElems.push(elem)\n            setShowComments(true)\n          }\n        }\n      }\n    }\n    return () => {\n      for (let i = 0; i < changedElems.length; i++) {\n        const changedElem = changedElems[i]\n        changedElem.classList.remove('selected')\n      }\n    }\n  }, [activeIDs, editor, markNodeMap])\n\n  // Apply/remove resolved CSS class on mark node DOM elements\n  useEffect(() => {\n    const updateResolvedClass = (threadId: string, resolved: boolean) => {\n      markNodeMap.get(threadId)?.forEach((key) => {\n        const elem = editor.getElementByKey(key)\n        elem?.classList.toggle('resolved', resolved)\n      })\n    }\n\n    comments\n      .filter((c): c is Thread => c.type === 'thread')\n      .forEach((thread) => updateResolvedClass(thread.id, thread.resolved ?? false))\n  }, [comments, editor, markNodeMap])\n\n  // Load comments when documentId changes\n  useEffect(() => {\n    if (documentId) {\n      commentStore.loadComments(documentId)\n    }\n  }, [commentStore, documentId])\n\n  return (\n    <>\n      {isDocumentSaved && showCommentInput &&\n        createPortal(\n          <CommentInputBox\n            author={currentUser}\n            cancelAddComment={cancelAddComment}\n            editor={editor}\n            setActiveAnchorKey={setActiveAnchorKey}\n            setShowCommentInput={setShowCommentInput}\n            submitAddComment={submitAddComment}\n          />,\n          document.body,\n        )}\n      {isDocumentSaved && activeAnchorKey !== null &&\n        !showCommentInput &&\n        createPortal(\n          <AddCommentBox\n            anchorKey={activeAnchorKey}\n            editor={editor}\n            onAddComment={onAddComment}\n          />,\n          document.body,\n        )}\n      {isDocumentSaved && createPortal(\n        <button\n          aria-label={showComments ? 'Hide Comments' : 'Show Comments'}\n          className={`CommentPlugin_ShowCommentsButton ${\n            showComments ? 'active' : ''\n          }`}\n          onClick={toggleComments}\n          title={showComments ? 'Hide Comments' : 'Show Comments'}\n        >\n          <i className=\"comments\" />\n        </button>,\n        document.body,\n      )}\n      {isDocumentSaved && showComments &&\n        createPortal(\n          <CommentsPanel\n            activeIDs={activeIDs}\n            comments={comments}\n            currentUser={currentUser}\n            deleteAllComments={deleteAllComments}\n            deleteCommentOrThread={deleteCommentOrThread}\n            markNodeMap={markNodeMap}\n            resolveThread={resolveThread}\n            submitAddComment={submitAddComment}\n          />,\n          document.body,\n        )}\n    </>\n  )\n}\n"],"names":["useLexicalComposerContext","React","useEffect","useMemo","useState","createPortal","useCommentCommands","useCommentMarks","useCommentOperations","useDocumentOperations","CommentStore","useCommentStore","AddCommentBox","CommentInputBox","CommentsPanel","CommentPlugin","currentUser","documentId","userCollectionSlug","editor","commentStore","comments","activeAnchorKey","setActiveAnchorKey","activeIDs","setActiveIDs","showCommentInput","setShowCommentInput","showComments","setShowComments","markNodeMap","isDocumentSaved","saveDocument","deleteAllComments","deleteCommentOrThread","resolveThread","submitAddComment","cancelAddComment","onAddComment","toggleComments","changedElems","i","length","id","keys","get","undefined","key","elem","getElementByKey","classList","add","push","changedElem","remove","updateResolvedClass","threadId","resolved","forEach","toggle","filter","c","type","thread","loadComments","author","document","body","anchorKey","button","aria-label","className","onClick","title"],"mappings":"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"}